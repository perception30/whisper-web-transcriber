!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports):"function"==typeof define&&define.amd?define(["exports"],t):t((e="undefined"!=typeof globalThis?globalThis:e||self).WhisperTranscriber={})}(this,(function(e){"use strict";class t{constructor(e={}){this.instance=null,this.mediaRecorder=null,this.audioContext=null,this.isRecording=!1,this.audio=null,this.audio0=null,this.Module=null,this.modelLoaded=!1,this.initPromise=null,this.config={modelUrl:e.modelUrl||t.MODEL_URLS[e.modelSize||"base-en-q5_1"],modelSize:e.modelSize||"base-en-q5_1",sampleRate:e.sampleRate||16e3,audioIntervalMs:e.audioIntervalMs||5e3,onTranscription:e.onTranscription||(()=>{}),onProgress:e.onProgress||(()=>{}),onStatus:e.onStatus||(()=>{}),debug:e.debug||!1}}log(e){this.config.debug&&console.log("[WhisperTranscriber]",e)}getScriptBasePath(){const e=document.getElementsByTagName("script");for(let t=0;t<e.length;t++){const i=e[t].src;if(i.includes("whisper-web-transcriber")){return i.substring(0,i.lastIndexOf("/")+1)}}return"localhost"===window.location.hostname?window.location.pathname.includes("/demo/")?"../dist/":"/node_modules/whisper-web-transcriber/dist/":"https://unpkg.com/whisper-web-transcriber/dist/"}async createWorkerFromURL(e){const t=await fetch(e),i=await t.text(),o=new Blob([i],{type:"application/javascript"}),s=URL.createObjectURL(o);return new Worker(s)}async loadWasmModule(){const e=this.getScriptBasePath();if(e.includes("unpkg.com")){const t=e+"libstream.worker.js";try{const e=await fetch(t),i=await e.text(),o=new Blob([i],{type:"application/javascript"}),s=URL.createObjectURL(o);window.__whisperWorkerBlobUrl=s}catch(e){this.log("Failed to pre-fetch worker: "+e)}}const t=document.createElement("script");return t.src=this.getScriptBasePath()+"libstream.js",new Promise(((e,i)=>{window.Module={locateFile:e=>"libstream.worker.js"===e&&window.__whisperWorkerBlobUrl?window.__whisperWorkerBlobUrl:this.getScriptBasePath()+e,onRuntimeInitialized:()=>{this.log("WASM runtime initialized"),setTimeout((()=>{const t=window.Module;t?(this.Module=t,t.init||(t.init=t.cwrap("init","number",["string"])),t.set_audio||(t.set_audio=t.cwrap("set_audio","",["number","array"])),t.get_transcribed||(t.get_transcribed=t.cwrap("get_transcribed","string",[])),t.set_status||(t.set_status=t.cwrap("set_status","",["string"])),this.log("WASM module loaded and functions initialized"),e()):i(new Error("Module not available after runtime initialized"))}),100)}},t.onerror=()=>i(new Error("Failed to load WASM module")),document.head.appendChild(t)}))}async loadHelpers(){const e=document.createElement("script");return e.src=this.getScriptBasePath()+"helpers.js",new Promise(((t,i)=>{e.onload=()=>t(),e.onerror=()=>i(new Error("Failed to load helpers")),document.head.appendChild(e)}))}async initialize(){return this.initPromise||(this.initPromise=(async()=>{try{window.dbVersion=1,window.dbName="whisper.transcriber.models",await this.loadHelpers(),this.log("Helpers loaded"),await this.loadWasmModule(),this.log("WASM module initialized"),this.config.onStatus("Ready to load model")}catch(e){throw this.log("Failed to initialize: "+e),e}})()),this.initPromise}async loadModel(){if(!this.modelLoaded)return await this.initialize(),new Promise(((e,i)=>{const o=this.config.modelUrl,s=t.MODEL_SIZES[this.config.modelSize];this.config.onStatus("Loading model...");window.loadRemote(o,"whisper.bin",s,(e=>{this.config.onProgress(Math.round(100*e))}),((t,i)=>{try{this.Module.FS_unlink(t)}catch(e){}this.Module.FS_createDataFile("/",t,i,!0,!0),this.log(`Model stored: ${t}, size: ${i.length}`),this.modelLoaded=!0,this.config.onStatus("Model loaded successfully"),e()}),(()=>{this.config.onStatus("Model loading cancelled"),i(new Error("Model loading cancelled"))}),(e=>{this.log(e)}))}));this.log("Model already loaded")}async startRecording(){if(!this.modelLoaded)throw new Error("Model not loaded. Call loadModel() first.");if(this.isRecording)return void this.log("Already recording");if(!this.instance){const e=this.Module.init||this.Module.cwrap("init","number",["string"]);if(this.instance=e("whisper.bin"),!this.instance)throw new Error("Failed to initialize Whisper");this.log("Whisper instance initialized")}this.audioContext=new AudioContext({sampleRate:this.config.sampleRate,channelCount:1,echoCancellation:!1,autoGainControl:!0,noiseSuppression:!0});(this.Module.set_status||this.Module.cwrap("set_status","",["string"]))(""),this.isRecording=!0,this.config.onStatus("Recording...");const e=[];try{const t=await navigator.mediaDevices.getUserMedia({audio:!0,video:!1});this.mediaRecorder=new MediaRecorder(t),this.mediaRecorder.ondataavailable=t=>{e.push(t.data);const i=new Blob(e,{type:"audio/ogg; codecs=opus"}),o=new FileReader;o.onload=e=>{const t=new Uint8Array(e.target.result);this.audioContext&&this.audioContext.decodeAudioData(t.buffer,(e=>{const t=new OfflineAudioContext(e.numberOfChannels,e.length,e.sampleRate),i=t.createBufferSource();i.buffer=e,i.connect(t.destination),i.start(0),t.startRendering().then((e=>{this.audio=e.getChannelData(0);const t=new Float32Array(null==this.audio0?this.audio.length:this.audio0.length+this.audio.length);if(null!=this.audio0&&t.set(this.audio0,0),t.set(this.audio,null==this.audio0?0:this.audio0.length),this.instance){(this.Module.set_audio||this.Module.cwrap("set_audio","",["number","array"]))(this.instance,t)}}))}))},o.readAsArrayBuffer(i)},this.mediaRecorder.onstop=()=>{this.isRecording&&setTimeout((()=>this.startRecording()),0)},this.mediaRecorder.start(this.config.audioIntervalMs),this.startTranscriptionPolling()}catch(e){throw this.isRecording=!1,this.config.onStatus("Error: "+e.message),e}}startTranscriptionPolling(){const e=setInterval((()=>{if(!this.isRecording)return void clearInterval(e);const t=(this.Module.get_transcribed||this.Module.cwrap("get_transcribed","string",[]))();null!=t&&t.length>1&&this.config.onTranscription(t)}),100)}stopRecording(){if(!this.isRecording)return void this.log("Not recording");(this.Module.set_status||this.Module.cwrap("set_status","",["string"]))("paused"),this.isRecording=!1,this.audio0=null,this.audio=null,this.mediaRecorder&&(this.mediaRecorder.stop(),this.mediaRecorder=null),this.audioContext&&(this.audioContext.close(),this.audioContext=null),this.config.onStatus("Stopped")}destroy(){this.stopRecording(),this.instance=null,this.Module=null,this.modelLoaded=!1}}t.MODEL_URLS={"tiny.en":"https://whisper.ggerganov.com/ggml-model-whisper-tiny.en.bin","base.en":"https://whisper.ggerganov.com/ggml-model-whisper-base.en.bin","tiny-en-q5_1":"https://whisper.ggerganov.com/ggml-model-whisper-tiny.en-q5_1.bin","base-en-q5_1":"https://whisper.ggerganov.com/ggml-model-whisper-base.en-q5_1.bin"},t.MODEL_SIZES={"tiny.en":75,"base.en":142,"tiny-en-q5_1":31,"base-en-q5_1":57},e.WhisperTranscriber=t}));
